version: 2.1

orbs:
  gh: circleci/github-cli@1.0
  sre: tracktor/ci-tools@0.1.5

references:
  staging_context: &staging_context
    - docker
  production_context: &production_context
    - docker
    - github
  pypi_context: &pypi_context
    - pypi
    - github

executors:

  build-docker:
    docker:
      - image: cimg/base:current

  build-wheel:
    docker:
      - image: cimg/python:3.10.8

  tests:
    docker:
      - image: cimg/python:3.10.8
      - image: cimg/postgres:14.9-postgis
        environment:
          POSTGRES_PASSWORD: postgres

jobs:

  # Testing

  run-tests:
    executor: tests
    steps:
      - checkout
      - run:
          name: Installing psql
          # Version should match the PG image
          command: |
            # Create the file repository configuration:
            sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
            # Import the repository signing key:
            wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
            sudo apt-get update && sudo apt-get install postgresql-client-13
      - sre/run-python-tests:
          extras: '--all-extras'
          before-steps:
            - run:
                name: Initializing DB
                command: ./tests/static/init-pg.sh
                environment:
                  PGHOST: 127.0.0.1
                  PGUSER: postgres
                  PGPASSWORD: postgres
                  INIT_FILE: ./tests/init.sql
                  SQL_FOLDER: ./tests/static

  # Docker Images

  export-requirements:
    executor: build-wheel
    steps:
      - checkout
      - sre/export-poetry:
          extras: '--without-hashes'

  export-requirements-network:
    executor: build-wheel
    steps:
      - checkout
      - sre/export-poetry:
          extras: '--without-hashes -E network'

  # Build

  build-docker-13:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-13/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-13
          latest_version: 'latest-13'
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-docker-network-13:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-13/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-network-13
          latest_version: 'latest-network-13'
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-docker-14:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-14/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-14
          latest_version: 'latest-14'
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-docker-network-14:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-14/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-network-14
          latest_version: 'latest-network-14'
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  # Publish

  build-publish-docker-13:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-13/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-13
          latest_version: 'latest-13'
          publish: true
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-publish-docker-network-13:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-13/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-network-13
          latest_version: 'latest-network-13'
          publish: true
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-publish-docker-14:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-14/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-14
          latest_version: 'latest-14'
          publish: true
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  build-publish-docker-network-14:
    executor: build-docker
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - checkout
      - attach_workspace:
          at: .
      - sre/load-poetry-version
      - sre/build-docker:
          dockerfile: './docker/pg-14/Dockerfile'
          image_name: 'tracktor/padmy'
          version: ${VERSION}-network-14
          latest_version: 'latest-network-14'
          publish: true
          registry_pwd: $CONTAINER_REGISTRY_PWD
          registry_user: $CONTAINER_REGISTRY_USER

  # Bump

  bump-version:
    executor: build-wheel
    steps:
      - gh/setup
      - checkout
      - restore_cache:
          keys:
            - deps-{{ checksum "poetry.lock" }}
      - run:
          name: Adding github.com to known hosts
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
      - run:
          name: Create release
          command: bash .circleci/scripts/release.sh
      - store_artifacts:
          path: dist
      - save_cache:
          name: Saving wheel
          key: padmy-{{ checksum "pyproject.toml" }}
          paths:
            - dist/

  publish:
    executor: build-wheel
    steps:
      - checkout
      - restore_cache:
          name: Restore wheel
          keys:
            - padmy-{{ checksum "pyproject.toml" }}
      - run:
          name: Publishing
          command: poetry publish -u __token__ -p $PYPI_TOKEN


workflows:

  run-tests:
    when:
      matches:
        pattern: "^(feat|feature|fix)\\/.*$"
        value: << pipeline.git.branch >>
    jobs:
      - run-tests

  production:
    when:
      matches:
        pattern: "^master$"
        value: << pipeline.git.branch >>
    jobs:
      - run-tests
      - export-requirements
      - export-requirements-network
      - build-publish-docker-13:
          requires: [
            run-tests,
            export-requirements
          ]
          context: *production_context
      - build-publish-docker-network-13:
          requires: [
            run-tests,
            export-requirements-network
          ]
          context: *production_context
      - build-publish-docker-14:
          requires: [
            run-tests,
            export-requirements
          ]
          context: *production_context
      - build-publish-docker-network-14:
          requires: [
            run-tests,
            export-requirements-network
          ]
          context: *production_context
      - bump-version:
          context: *production_context
          requires: [ run-tests ]

  publish:
    jobs:
      - publish:
          context: *pypi_context
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
